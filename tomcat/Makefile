SHELL := /bin/bash
.DEFAULT_GOAL := alljames.md

.PHONY: build_fat build_slim run_fat run_slim
build_fat:
	docker build --file=fat.Dockerfile --tag=localhost:5000/tomcat:fat .

build_slim:
	docker build --file=slim.Dockerfile --tag=localhost:5000/tomcat:slim .

run_fat: build_fat
	docker run --rm \
	 --publish 8080:8080 \
	 localhost:5000/tomcat:fat

run_slim: build_slim
	docker run --rm \
	 --publish 8080:8080 \
	 localhost:5000/tomcat:slim

.PHONY: alljames.md
FILE := $(CURDIR)/../vulnz/alljames.md
alljames.md: build_fat build_slim
	touch "${FILE}" && rm "${FILE}" && touch "${FILE}"

	printf "## tomcat-server-fat\n\n" >> "${FILE}"
	docker run --rm \
	 --cpus=1 --memory=1g \
	 --volume /var/run/docker.sock:/var/run/docker.sock \
	 --volume /tmp/grype-db-host:/tmp/grype-db-container \
	 --env=GRYPE_DB_CACHE_DIR=/tmp/grype-db-container \
	 anchore/grype:latest -v --by-cve \
	 localhost:5000/tomcat:fat >> "${FILE}"

	printf "\n" >> "${FILE}"

	printf "## tomcat-server-chainguard\n\n" >> "${FILE}"	
	docker run --rm \
	 --cpus=1 --memory=1g \
	 --volume /var/run/docker.sock:/var/run/docker.sock \
	 --volume /tmp/grype-db-host:/tmp/grype-db-container \
	 --env=GRYPE_DB_CACHE_DIR=/tmp/grype-db-container \
	 anchore/grype:latest -v --by-cve \
	 localhost:5000/tomcat:slim >> "${FILE}"